# TARS CUDA Vector Store Makefile
# Compile in WSL with CUDA support

# CUDA Compiler
NVCC = nvcc

# Compiler flags
NVCC_FLAGS = -shared -Xcompiler -fPIC -O3 -arch=sm_75
CUDA_LIBS = -lcublas -lcurand

# Source and target files
SOURCE = cuda_vector_store.cu
TARGET = libtars_cuda.so
TEST_TARGET = tars_cuda_test

# Default target
all: $(TARGET)

# Build shared library for .NET P/Invoke
$(TARGET): $(SOURCE)
	@echo "üöÄ Compiling TARS CUDA Vector Store..."
	@echo "üìÅ Source: $(SOURCE)"
	@echo "üéØ Target: $(TARGET)"
	$(NVCC) $(NVCC_FLAGS) -o $(TARGET) $(SOURCE) $(CUDA_LIBS)
	@echo "‚úÖ CUDA library compiled successfully!"
	@echo "üì¶ Output: $(TARGET)"

# Build test executable
test: $(SOURCE)
	@echo "üß™ Building CUDA test executable..."
	$(NVCC) -O3 -arch=sm_75 -o $(TEST_TARGET) $(SOURCE) $(CUDA_LIBS) -DTEST_MAIN
	@echo "‚úÖ Test executable built: $(TEST_TARGET)"

# Run test
run-test: test
	@echo "üöÄ Running CUDA Vector Store Test..."
	./$(TEST_TARGET)

# Check CUDA installation
check-cuda:
	@echo "üîç Checking CUDA installation..."
	@nvcc --version || echo "‚ùå CUDA not found - install CUDA toolkit"
	@nvidia-smi || echo "‚ùå NVIDIA driver not found"

# Clean build artifacts
clean:
	@echo "üßπ Cleaning build artifacts..."
	rm -f $(TARGET) $(TEST_TARGET)
	@echo "‚úÖ Clean complete"

# Install to system (optional)
install: $(TARGET)
	@echo "üì¶ Installing TARS CUDA library..."
	sudo cp $(TARGET) /usr/local/lib/
	sudo ldconfig
	@echo "‚úÖ Library installed to /usr/local/lib/"

# Help
help:
	@echo "üöÄ TARS CUDA Vector Store Build System"
	@echo ""
	@echo "Available targets:"
	@echo "  all        - Build shared library (default)"
	@echo "  test       - Build test executable"
	@echo "  run-test   - Build and run test"
	@echo "  check-cuda - Check CUDA installation"
	@echo "  clean      - Remove build artifacts"
	@echo "  install    - Install library to system"
	@echo "  help       - Show this help"
	@echo ""
	@echo "Requirements:"
	@echo "  - CUDA Toolkit (nvcc)"
	@echo "  - NVIDIA GPU with compute capability 7.5+"
	@echo "  - WSL with CUDA support"

.PHONY: all test run-test check-cuda clean install help
