namespace TarsEngine.FSharp.Cli.Commands

open System
open System.IO
open System.Threading.Tasks
open Microsoft.Extensions.Logging
open TarsEngine.FSharp.Core.Projects

type ProjectCommand(
    projectService: IAutonomousProjectService,
    logger: ILogger<ProjectCommand>) =
    
    interface ICommand with
        member _.Name = "project"
        member _.Description = "TARS autonomous project creation from simple prompts"
        member self.Usage = "tars project <subcommand> [options]"
        member self.Examples = [
            "tars project create \"file backup system\"     - Create project from prompt"
            "tars project demo                             - Demo project creation"
            "tars project list                             - List created projects"
            "tars project validate <path>                  - Validate project"
        ]
        member self.ValidateOptions(_) = true
        
        member self.ExecuteAsync(options) =
            task {
                try
                    match options.Arguments with
                    | "create" :: prompt ->
                        let fullPrompt = String.concat " " prompt
                        
                        printfn "üöÄ TARS AUTONOMOUS PROJECT CREATION"
                        printfn "==================================="
                        printfn "Prompt: %s" fullPrompt
                        printfn ""
                        
                        printfn "üß† Analyzing prompt with Codestral LLM..."
                        printfn "üìã Generating project structure..."
                        printfn "üìù Creating files and metascripts..."
                        printfn "üß™ Generating comprehensive tests..."
                        printfn "üîç Validating project quality..."
                        printfn ""
                        
                        let! result = projectService.CreateProjectFromPromptAsync(fullPrompt)
                        
                        printfn "üéâ PROJECT CREATION COMPLETE!"
                        printfn "============================="
                        printfn ""
                        printfn "üìä Project Summary:"
                        printfn "  üéØ Name: %s" result.ProjectStructure.ProjectName
                        printfn "  üìÅ Location: %s" result.OutputPath
                        printfn "  üìÑ Files Generated: %d" result.GeneratedFiles
                        printfn "  üß™ Tests Created: %d" result.TestsGenerated
                        printfn "  ‚úÖ Validation: %s" (if result.ValidationResults then "PASSED" else "NEEDS IMPROVEMENT")
                        printfn "  ‚è±Ô∏è  Generation Time: %dms" (int result.ExecutionTime.TotalMilliseconds)
                        printfn ""
                        
                        printfn "üìÅ Project Structure Created:"
                        for dir in result.ProjectStructure.Directories do
                            printfn "  üìÇ %s/" dir
                        
                        printfn ""
                        printfn "üìÑ Key Files Generated:"
                        for KeyValue(file, _) in result.ProjectStructure.Files |> Map.toSeq |> Seq.take 5 do
                            printfn "  üìÑ %s" file
                        
                        printfn ""
                        printfn "üöÄ Ready for Use!"
                        printfn "  Navigate to: %s" result.OutputPath
                        printfn "  Run tests: tars test run %s" result.OutputPath
                        printfn "  Deploy: Execute scripts/deploy.tars"
                        
                        return CommandResult.success("Project creation completed")
                    
                    | "demo" :: _ ->
                        printfn "üé¨ TARS AUTONOMOUS PROJECT CREATION DEMO"
                        printfn "========================================"
                        printfn ""
                        
                        printfn "üöÄ Demonstrating full autonomous project creation workflow..."
                        printfn ""
                        
                        let! result = projectService.DemoProjectCreationAsync()
                        
                        printfn ""
                        printfn "üéâ DEMO COMPLETE!"
                        printfn "================="
                        printfn ""
                        printfn "‚úÖ Demonstrated TARS Autonomous Capabilities:"
                        printfn "  üß† Prompt Analysis - Understood project requirements"
                        printfn "  üìã Structure Generation - Created comprehensive project layout"
                        printfn "  üìù File Creation - Generated source code, configs, docs"
                        printfn "  üß™ Test Generation - Created unit, integration, performance tests"
                        printfn "  üîç Quality Validation - Ensured production readiness"
                        printfn "  ÔøΩÔøΩ Metrics Collection - Tracked generation performance"
                        printfn ""
                        printfn "üéØ Project Created: %s" result.ProjectStructure.ProjectName
                        printfn "üìÅ Location: %s" result.OutputPath
                        printfn ""
                        printfn "üöÄ TARS can create complete projects from simple prompts!"
                        
                        return CommandResult.success("Demo completed")
                    
                    | "list" :: _ ->
                        printfn "üìã TARS GENERATED PROJECTS"
                        printfn "=========================="
                        printfn ""
                        
                        let projectsDir = ".tars/projects"
                        if Directory.Exists(projectsDir) then
                            let projects = Directory.GetDirectories(projectsDir)
                            
                            if projects.Length > 0 then
                                printfn "Found %d autonomous projects:" projects.Length
                                printfn ""
                                
                                for i, projectPath in projects |> Array.indexed do
                                    let projectName = Path.GetFileName(projectPath)
                                    let metadataPath = Path.Combine(projectPath, ".tars_project.json")
                                    
                                    printfn "%d. %s" (i + 1) projectName
                                    printfn "   üìÅ Path: %s" projectPath
                                    
                                    if File.Exists(metadataPath) then
                                        let metadata = File.ReadAllText(metadataPath)
                                        printfn "   üìä Metadata: Available"
                                    else
                                        printfn "   üìä Metadata: Not found"
                                    
                                    let srcDir = Path.Combine(projectPath, "src")
                                    let testsDir = Path.Combine(projectPath, "tests")
                                    let scriptsDir = Path.Combine(projectPath, "scripts")
                                    
                                    let srcFiles = if Directory.Exists(srcDir) then Directory.GetFiles(srcDir).Length else 0
                                    let testFiles = if Directory.Exists(testsDir) then Directory.GetFiles(testsDir).Length else 0
                                    let scriptFiles = if Directory.Exists(scriptsDir) then Directory.GetFiles(scriptsDir).Length else 0
                                    
                                    printfn "   üìÑ Source files: %d" srcFiles
                                    printfn "   üß™ Test files: %d" testFiles
                                    printfn "   üìú Scripts: %d" scriptFiles
                                    printfn ""
                            else
                                printfn "No autonomous projects found."
                                printfn "üí° Use 
tars
project
create
\your idea\ to create one!"
                        else
                            printfn "Projects directory not found."
                            printfn "üí° Use tars
project
create
\your idea\ to create your first project!"
                        
                        return CommandResult.success("Project list displayed")
                    
                    | "validate" :: projectPath :: _ ->
                        printfn "üîç TARS PROJECT VALIDATION"
                        printfn "=========================="
                        printfn "Project: %s" projectPath
                        printfn ""
                        
                        printfn "üîç Validating project structure..."
                        printfn "üß™ Checking test coverage..."
                        printfn "üìä Analyzing quality metrics..."
                        printfn ""
                        
                        let! isValid = projectService.ValidateProjectAsync(projectPath)
                        
                        if isValid then
                            printfn "‚úÖ PROJECT VALIDATION PASSED"
                            printfn "============================"
                            printfn "üéâ The project meets all quality criteria:"
                            printfn "  ‚úÖ Valid project structure"
                            printfn "  ‚úÖ Source files present"
                            printfn "  ‚úÖ Test files available"
                            printfn "  ‚úÖ Metascripts included"
                            printfn "  ‚úÖ Documentation complete"
                            printfn ""
                            printfn "üöÄ Project is ready for production use!"
                        else
                            printfn "‚ùå PROJECT VALIDATION FAILED"
                            printfn "============================"
                            printfn "‚ö†Ô∏è  The project needs improvement:"
                            printfn "  ‚ùå Missing required structure or files"
                            printfn "  üí° Use tars
project
create to regenerate"
                            printfn ""
                            printfn "üîß Consider regenerating the project with TARS"
                        
                        return CommandResult.success("Project validation completed")
                    
                    | "explore" :: projectPath :: _ ->
                        printfn "üîç TARS PROJECT EXPLORATION"
                        printfn "==========================="
                        printfn "Project: %s" projectPath
                        printfn ""
                        
                        if Directory.Exists(projectPath) then
                            printfn "üìÅ Project Structure:"
                            let dirs = Directory.GetDirectories(projectPath)
                            for dir in dirs do
                                let dirName = Path.GetFileName(dir)
                                let fileCount = Directory.GetFiles(dir, "*", SearchOption.AllDirectories).Length
                                printfn "  üìÇ %s/ (%d files)" dirName fileCount
                            
                            printfn ""
                            printfn "üìÑ Key Files:"
                            let keyFiles = ["README.md"; "src/main.fs"; "tests/test_main.fs"; "scripts/deploy.tars"]
                            for file in keyFiles do
                                let filePath = Path.Combine(projectPath, file)
                                if File.Exists(filePath) then
                                    let size = (new FileInfo(filePath)).Length
                                    printfn "  ÔøΩÔøΩ %s (%d bytes)" file size
                                else
                                    printfn "  ‚ùå %s (missing)" file
                            
                            printfn ""
                            printfn "üß™ Test Coverage:"
                            let testsDir = Path.Combine(projectPath, "tests")
                            if Directory.Exists(testsDir) then
                                let testFiles = Directory.GetFiles(testsDir, "*.fs")
                                printfn "  üß™ Test files: %d" testFiles.Length
                                for testFile in testFiles do
                                    printfn "    üìÑ %s" (Path.GetFileName(testFile))
                            else
                                printfn "  ‚ùå No tests directory found"
                            
                            printfn ""
                            printfn "üìú Metascripts:"
                            let scriptsDir = Path.Combine(projectPath, "scripts")
                            if Directory.Exists(scriptsDir) then
                                let scriptFiles = Directory.GetFiles(scriptsDir, "*.tars")
                                printfn "  üìú Metascripts: %d" scriptFiles.Length
                                for scriptFile in scriptFiles do
                                    printfn "    üìú %s" (Path.GetFileName(scriptFile))
                            else
                                printfn "  ‚ùå No scripts directory found"
                        else
                            printfn "‚ùå Project directory not found: %s" projectPath
                        
                        return CommandResult.success("Project exploration completed")
                    
                    | "status" :: _ ->
                        printfn "üöÄ TARS AUTONOMOUS PROJECT SYSTEM STATUS"
                        printfn "========================================"
                        printfn ""
                        printfn "ü§ñ Autonomous Project Service: ‚úÖ Active"
                        printfn "üß† Prompt Analysis: ‚úÖ Operational (Codestral LLM)"
                        printfn "üìã Structure Generation: ‚úÖ Operational"
                        printfn "üìù File Creation: ‚úÖ Operational"
                        printfn "üß™ Test Generation: ‚úÖ Operational"
                        printfn "üîç Quality Validation: ‚úÖ Operational"
                        printfn ""
                        printfn "üìä Project Types Supported:"
                        printfn "  üîê Authentication Systems"
                        printfn "  üíæ Backup Solutions"
                        printfn "  üåê API Services"
                        printfn "  üìä Data Processing"
                        printfn "  üîß Utility Tools"
                        printfn "  üì± Any Custom Project"
                        printfn ""
                        printfn "üéØ TARS can create complete projects from simple prompts!"
                        printfn "   Just describe what you want and TARS will build it."
                        
                        return CommandResult.success("Status displayed")
                    
                    | [] ->
                        printfn "TARS Autonomous Project Creation Commands:"
                        printfn "  create \"<prompt>\"     - Create project from natural language prompt"
                        printfn "  demo                  - Demonstrate autonomous project creation"
                        printfn "  list                  - List all generated projects"
                        printfn "  validate <path>       - Validate project quality"
                        printfn "  explore <path>        - Explore project structure"
                        printfn "  status                - Show project system status"
                        printfn ""
                        printfn "Examples:"
                        printfn "  tars project create \"file backup system with encryption\""
                        printfn "  tars project create \"REST API for user management\""
                        printfn "  tars project create \"data processing pipeline\""
                        return CommandResult.success("Help displayed")
                    
                    | unknown :: _ ->
                        printfn "Unknown project command: %s" unknown
                        return CommandResult.failure("Unknown command")
                with
                | ex ->
                    logger.LogError(ex, "Project command error")
                    return CommandResult.failure(ex.Message)
            }

