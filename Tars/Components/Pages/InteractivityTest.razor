@page "/test"
@using TarsEngine.Services
@using Microsoft.AspNetCore.Components
@rendermode InteractiveServer
@inject RivaWrapperService RivaService
@inject ILogger<InteractivityTest> Logger
@inject IJSRuntime JSRuntime
@inject ISnackbar Snackbar
@inject SpeechServiceFactory SpeechFactory

<PageTitle>Interactivity Test</PageTitle>

<MudPaper Class="pa-4">
    <MudText Typo="Typo.h4" Class="mb-4">Interactivity Test Page</MudText>

    <MudTabs Elevation="2" Rounded="true" PanelClass="pa-6">
        <MudTabPanel Text="Basic Controls">
            <MudText Class="mb-4">
                Current count: @_count
            </MudText>

            <MudButton Variant="Variant.Filled" 
                      Color="Color.Primary"
                      OnClick="IncrementCount">
                Increment Counter
            </MudButton>
        </MudTabPanel>

        <MudTabPanel Text="Speech Synthesis" Icon="@Icons.Material.Filled.RecordVoiceOver">
            <MudText Typo="Typo.h6" Class="mb-4">Text-to-Speech Test</MudText>
            
            <MudTextField T="string"
                         @bind-Value="_textToSpeak"
                         Label="Text to speak"
                         Variant="Variant.Outlined"
                         Lines="3"
                         Class="mb-4"/>

            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       OnClick="SpeakText"
                       Disabled="@_isSpeaking">
                @(_isSpeaking ? "Speaking..." : "Speak Text")
            </MudButton>
        </MudTabPanel>

        <MudTabPanel Text="Text Input" Icon="@Icons.Material.Filled.Edit">
            <MudText Typo="Typo.h6" Class="mb-4">Text Input Test</MudText>
            
            <MudTextField T="string"
                         @bind-Value="_inputText"
                         Label="Type something"
                         Variant="Variant.Outlined"
                         Immediate="true"
                         Class="mb-4"/>

            <MudText>
                You typed: @_inputText
            </MudText>
        </MudTabPanel>
    </MudTabs>
</MudPaper>

@code {
    private int _count = 0;
    private string _inputText = "";
    private string _textToSpeak = "Hello, I am TARS. How can I assist you today?";
    private bool _isSpeaking = false;
    private IJSObjectReference? _audioModule;
    private string _selectedSpeechService = "webspeech";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                _audioModule = await JSRuntime.InvokeAsync<IJSObjectReference>(
                    "import", "./js/audioHelpers.js");
                Logger.LogInformation("Audio module loaded successfully");
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Failed to load audio module");
                Snackbar.Add("Failed to initialize audio system", Severity.Error);
            }
        }
    }

    private void IncrementCount()
    {
        _count++;
        StateHasChanged();
    }

    private async Task SpeakText()
    {
        if (string.IsNullOrEmpty(_textToSpeak) || _isSpeaking)
        {
            return;
        }

        try
        {
            _isSpeaking = true;
            StateHasChanged();
            
            // Create and use a SpeechSynthesisUtterance directly
            await JSRuntime.InvokeVoidAsync("eval", @"
                const utterance = new SpeechSynthesisUtterance('" + _textToSpeak.Replace("'", "\\'") + @"');
                window.speechSynthesis.speak(utterance);
            ");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error during speech synthesis");
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSpeaking = false;
            StateHasChanged();
        }
    }
}